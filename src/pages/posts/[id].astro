---
import { getCollection, render } from "astro:content";
import PostLayout from "@/layouts/PostLayout.astro";
import { DemoRenderer } from "@/components/DemoRender";
import { filterPosts } from "@/lib/utils";
import { getImage } from "astro:assets";
import Divider from "@/components/primitives/Divider.astro";
import CodeBlockWrapper from "@/components/CodeBlockWrapper.astro";
import Blockquote from "@/components/Blockquote.astro";
import { ToC } from "@/components/ToC";
import Navbar from "@/components/Navbar.astro";
import Prose from "@/components/Prose.astro";
import Layout from "@/layouts/Layout.astro";

import ThemeToggle from "@/components/ThemeToggle.astro";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  const pathsPromises = posts.map(async (post) => {
    let images: any = {};
    if (post.data.image) {
      const optimizedImage = await getImage({
        src: post.data.image,
        width: 1000,
        height: 1000,
        format: "avif",
        quality: 100,
      });
      images.optimizedImageSrc = optimizedImage.src;

      // Generate OG image (1200x630 is the recommended OG image size)
      const ogImage = await getImage({
        src: post.data.image,
        width: 1200,
        height: 630,
        format: "png",
        quality: 90,
      });
      images.ogImageSrc = `${Astro.site || "https://heymynameisrob.com"}${ogImage.src}`;
    }

    if (post.data.imageDark) {
      const optimizedImageDark = await getImage({
        src: post.data.imageDark,
        width: 1000,
        height: 1000,
        format: "avif",
        quality: 100,
      });
      images.optimizedImageDarkSrc = optimizedImageDark.src;
    }

    return {
      params: { id: post.id },
      props: { post: { ...post, ...images } },
    };
  });

  return Promise.all(pathsPromises);
}

const { post } = Astro.props;
const { Content, headings } = await render(post);

---

<Layout
  title={`${post.data.title} - @heymynameisrob`}
  description={post.data.description}
  og={post.ogImageSrc}
  canonical={post.data.canonical}
>
  <div class="max-h-screen overflow-y-scroll mask-linear mask-b-to-transparent mask-b-from-90% animate-in fade-in-0 blur-in-md duration-400 ease-out">
    <Navbar />
    <div
      class="max-w-3xl mx-auto px-5 flex flex-col justify-center items-center py-12 lg:py-24"
    >
      <header class="flex flex-col justify-center items-center text-center">
        <h1
          class="text-2xl font-serif tracking-tight lg:text-3xl lg:text-balance xl:text-4xl"
        >
          {post.data.title}
        </h1>
        <h2
          class="text-2xl font-serif tracking-tight lg:text-3xl lg:text-balance text-gray-10 xl:text-4xl"
        >
          {post.data.description}
        </h2>
      </header>
      <Divider />
      <Prose>
        <Content components={{ hr: Divider, pre: CodeBlockWrapper, blockquote: Blockquote }} />
      </Prose>
      <footer class="w-full flex items-center justify-between mt-12 lg:mt-24">
        <small class="text-gray-9">&copy; 2025 heymynameisrob</small>
        <ThemeToggle />
      </footer>
    </div>
  </div>
  <ToC headings={headings} client:load />
</Layout>
