---
import { getCollection } from "astro:content";
import { getImage } from "astro:assets";
import Layout from "@/layouts/Layout.astro";
import HomeNav from "@/components/HomeNav.astro";
import HomeHeader from "@/components/HomeHeader.astro";

import { ScrollStrip } from "@/components/ScrollStrip";

import { filterPosts } from "@/lib/utils";

const allPosts = await getCollection("posts");
const allValidPosts = filterPosts(allPosts);

const postsWithOptimizedImages = await Promise.all(
  allValidPosts.map(async (post) => {
    let images: any = {};
    if (post.data.image) {
      const optimizedImage = await getImage({
        src: post.data.image,
        width: 1000,
        height: 1000,
        format: "avif",
        quality: 100,
      });
      images.optimizedImageSrc = optimizedImage.src;
    }

    if (post.data.imageDark) {
      const optimizedImageDark = await getImage({
        src: post.data.imageDark,
        width: 1000,
        height: 1000,
        format: "avif",
        quality: 100,
      });
      images.optimizedImageDarkSrc = optimizedImageDark.src;
    }

    return { ...post, ...images };
  }),
);
---

<Layout>
  <HomeNav />
  <HomeHeader />
  <ScrollStrip posts={postsWithOptimizedImages} client:only="react" />
</Layout>
